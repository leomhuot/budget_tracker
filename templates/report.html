{% extends 'base.html' %}

{% block title %}Budget Report - Budget Tracker{% endblock %}

{% block head_extra %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
{% endblock %}

{% block content %}
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }}">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="mb-0">Report Summary</h1>
        <button class="btn btn-secondary" onclick="exportReportToPdf()">
            <i class="fa-solid fa-download me-2"></i> Export to PDF
        </button>
    </div>

    <div id="report-content"> <!-- Wrap the entire report content for easy capture -->
        <div class="card shadow-sm mb-4">
            <div class="card-header">
                <ul class="nav nav-pills card-header-pills">
                    <li class="nav-item">
                        <a class="nav-link {{ 'active' if report.period == 'daily' }}" href="{{ url_for('report', period='daily') }}">Daily</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {{ 'active' if report.period == 'weekly' }}" href="{{ url_for('report', period='weekly') }}">Weekly</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {{ 'active' if report.period == 'monthly' }}" href="{{ url_for('report', period='monthly') }}">Monthly</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {{ 'active' if report.period == 'yearly' }}" href="{{ url_for('report', period='yearly') }}">Yearly</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {{ 'active' if report.period == 'last_year_to_date' }}" href="{{ url_for('report', period='last_year_to_date') }}">Last Year to Date</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {{ 'active' if report.period == 'custom' }}" href="{{ url_for('report', period='custom') }}">Custom</a>
                    </li>
                </ul>
            </div>
            <div class="card-body">
                <h5 class="card-title">
                    {% if report.period == "custom" %}
                        Report for: {{ start_date }} to {{ end_date }}
                    {% elif report.period == "last_year_to_date" %}
                        Report for: Last Year to Date
                    {% else %}
                        Report for: {{ report.period|capitalize }}
                    {% endif %}
                </h5>
                <form action="{{ url_for('report') }}" method="get" class="row g-3 align-items-end mb-3">
                    <input type="hidden" name="period" value="custom">
                    <div class="col-md-4">
                        <label for="start_date" class="form-label">Start Date</label>
                        <input type="date" class="form-control" id="start_date" name="start_date" value="{{ start_date if start_date else '' }}">
                    </div>
                    <div class="col-md-4">
                        <label for="end_date" class="form-label">End Date</label>
                        <input type="date" class="form-control" id="end_date" name="end_date" value="{{ end_date if end_date else '' }}">
                    </div>
                    <div class="col-md-4">
                        <button type="submit" class="btn btn-primary w-100">Apply Custom Range</button>
                    </div>
                </form>

                <form action="{{ url_for('report') }}" method="get" class="row g-3 align-items-end mb-3">
                    <input type="hidden" name="period" value="{{ current_period }}">
                    <input type="hidden" name="start_date" value="{{ start_date if start_date else '' }}">
                    <input type="hidden" name="end_date" value="{{ end_date if end_date else '' }}">
                    <input type="hidden" name="page" value="1"> {# Reset to page 1 on new search #}
                    <input type="hidden" name="per_page" value="{{ per_page }}">
                    <div class="col-md-8">
                        <label for="search_query" class="form-label visually-hidden">Search Transactions</label>
                        <input type="text" class="form-control" id="search_query" name="search_query" value="{{ search_query if search_query else '' }}" placeholder="Search by item, category, amount, etc.">
                    </div>
                    <div class="col-md-4">
                        <button type="submit" class="btn btn-primary w-100">Search</button>
                    </div>
                </form>
            </div>
        </div>

        {% if report and report.period == 'monthly' %}
        <div class="card shadow-sm mb-4">
            <div class="card-header"><h2 class="h5 mb-0">Monthly Budget Goals</h2></div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6 col-md-3 mb-3">
                        <div class="stat-card">
                            <div class="fs-6 text-muted">Total Budget</div>
                            <div class="fs-4 fw-bold">${{ "%.2f"|format(report.total_budget) }}</div>
                        </div>
                    </div>
                    <div class="col-6 col-md-3 mb-3">
                        <div class="stat-card">
                            <div class="fs-6 text-muted">Savings Goal</div>
                            <div class="fs-4 fw-bold income">${{ "%.2f"|format(report.savings_goal) }}</div>
                        </div>
                    </div>
                    <div class="col-6 col-md-3 mb-3">
                        <div class="stat-card">
                            <div class="fs-6 text-muted">Total Spent</div>
                            <div class="fs-4 fw-bold expense">${{ "%.2f"|format(displayed_total_expense) }}</div>
                        </div>
                    </div>
                    <div class="col-6 col-md-3 mb-3">
                        <div class="stat-card">
                            <div class="fs-6 text-muted">Remaining to Spend</div>
                            <div class="fs-4 fw-bold {{ 'text-success' if report.remaining_spending >= 0 else 'text-danger' }}">
                                ${{ "%.2f"|format(report.remaining_spending) }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        {% if report %}
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-3">
                        <div class="card">
                            <div class="card-header">Period Income</div>
                            <div class="card-body"><h2 class="card-title text-success">${{ "%.2f"|format(report.total_income) }}</h2></div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card">
                            <div class="card-header">Period Expense</div>
                            <div class="card-body"><h2 class="card-title text-danger">${{ "%.2f"|format(displayed_total_expense) }}</h2></div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card">
                            <div class="card-header">Period Balance</div>
                            <div class="card-body"><h2 class="card-title text-info">${{ "%.2f"|format(report.balance) }}</h2></div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card">
                            <div class="card-header">Total Savings</div>
                            <div class="card-body"><h2 class="card-title text-primary">${{ "%.2f"|format(report.total_savings) }}</h2></div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card">
                            <div class="card-header">Goal Savings</div>
                            <div class="card-body"><h2 class="card-title text-success">${{ "%.2f"|format(report.total_goal_savings) }}</h2></div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card">
                            <div class="card-header">General Savings</div>
                            <div class="card-body"><h2 class="card-title text-info">${{ "%.2f"|format(report.total_general_savings) }}</h2></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {% if report.period == 'yearly' and report.monthly_summaries %}
        <div class="card shadow-sm mt-4 mb-4">
            <div class="card-header">
                <h2 class="h5 mb-0">Monthly Breakdown for the Year</h2>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Month</th>
                                <th class="text-end">Income</th>
                                <th class="text-end">Expense</th>
                                <th class="text-end">Balance</th>
                                <th class="text-end">Savings</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for month_summary in report.monthly_summaries %}
                            <tr>
                                <td>{{ month_summary.month }}</td>
                                <td class="text-end text-success">${{ "%.2f"|format(month_summary.total_income) }}</td>
                                <td class="text-end text-danger">${{ "%.2f"|format(month_summary.total_expense) }}</td>
                                <td class="text-end text-info">${{ "%.2f"|format(month_summary.balance) }}</td>
                                <td class="text-end text-primary">${{ "%.2f"|format(month_summary.total_savings) }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}


        <div class="card shadow-sm mb-4">
            <div class="card-header">
                <h2 class="h5 mb-0">Savings Goals Progress</h2>
            </div>
            <div class="card-body">
                {% if savings_goals %}
                    {% for goal in savings_goals %}
                        <div class="mb-3">
                            <h5>{{ goal.name }}</h5>
                            <div class="progress" style="height: 25px;">
                                <div class="progress-bar" role="progressbar" style="width: {{ (goal.saved_amount / goal.target_amount) * 100 }}%;" aria-valuenow="{{ goal.saved_amount }}" aria-valuemin="0" aria-valuemax="{{ goal.target_amount }}">
                                    ${{ "%.2f"|format(goal.saved_amount) }}
                                </div>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>${{ "%.2f"|format(goal.saved_amount) }} / ${{ "%.2f"|format(goal.target_amount) }}</span>
                                <span>{{ "%.2f"|format((goal.saved_amount / goal.target_amount) * 100) }}%</span>
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <p class="text-center">No savings goals yet. <a href="{{ url_for('manage_savings_goals') }}">Add one!</a></p>
                {% endif %}
            </div>
        </div>


        <div class="row">
            <div class="col-md-6">
                <!-- Chart Section -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header">Expense Breakdown</div>
                    <div class="card-body">
                        <div class="d-flex justify-content-center">
                            <div style="width: 400px; height: 400px;">
                                <canvas id="expensePieChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card shadow-sm mb-4">
                    <div class="card-header">Income Breakdown by Item</div>
                    <div class="card-body">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th class="text-end">Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if report.income_breakdown_by_item %}
                                    {% for item, amount in report.income_breakdown_by_item.items() %}
                                        <tr>
                                            <td>{{ item }}</td>
                                            <td class="text-end text-success">${{ "%.2f"|format(amount) }}</td>
                                        </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="2" class="text-center">No income data for this period.</td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                {% if report and report.transactions %}
                <h2 class="h4">Transactions in this Period</h2>
                <div class="card shadow-sm mb-4">
                    {% if displayed_transactions %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover mb-0 align-middle">
                            <thead>
                                <tr>
                                    <th scope="col">Date</th>
                                    <th scope="col">Type</th>
                                    <th scope="col">Category</th>
                                    <th scope="col">Item</th>
                                    <th scope="col">Description</th>
                                    <th scope="col" class="text-end">Amount</th>
                                    <th scope="col" class="text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for t in displayed_transactions %}
                                <tr>
                                    <td>{{ t.date }}</td>
                                    <td>{{ t.type|capitalize }}</td>
                                    <td>
                                        {% if t.type == 'income' %}
                                            <i class="fa-solid {{ income_category_icons.get(t.category, income_category_icons._default) }} me-2"></i>{{ t.category|capitalize }}
                                        {% else %}
                                            <i class="fa-solid {{ category_icons.get(t.category, category_icons._default) }} me-2"></i>{{ t.category|capitalize }}
                                        {% endif %}
                                    </td>
                                    <td>{{ t.item }}</td>
                                    <td>{{ t.description }}</td>
                                    <td class="text-end {{ 'text-success' if t.type == 'income' else 'text-danger' }}">
                                        ${{ "%.2f"|format(t.amount) }}
                                    </td>
                                    <td class="text-center action-buttons">
                                        <a href="{{ url_for('edit', transaction_id=t.id) }}" class="btn btn-sm btn-outline-primary" title="Edit">
                                            <i class="fa-solid fa-pencil"></i>
                                        </a>
                                        <a href="{{ url_for('delete', transaction_id=t.id) }}" class="btn btn-sm btn-outline-danger" title="Delete" onclick="return confirm('Are you sure you want to delete this item?');">
                                            <i class="fa-solid fa-trash"></i>
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="card-body text-center">
                        <p class="lead">No transactions found for this period.</p>
                    </div>
                    {% endif %}
                </div>

                <div class="d-flex justify-content-between align-items-center mt-3">
                    <div>
                        Showing {{ (page - 1) * per_page + 1 }} - {{ (page - 1) * per_page + displayed_transactions|length }} of {{ total_transactions }} transactions
                    </div>
                    <div class="d-flex align-items-center">
                        <label for="per_page_select" class="form-label me-2 mb-0">Transactions per page:</label>
                        <select class="form-select form-select-sm w-auto" id="per_page_select" onchange="window.location.href = '{{ url_for('report', page=1, search_query=search_query, period=current_period, start_date=start_date, end_date=end_date) }}&per_page=' + this.value">
                            <option value="10" {% if per_page == 10 %}selected{% endif %}>10</option>
                            <option value="20" {% if per_page == 20 %}selected{% endif %}>20</option>
                            <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
                            <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
                        </select>
                    </div>
                    <nav aria-label="Page navigation">
                        <ul class="pagination mb-0">
                            <li class="page-item {% if page == 1 %}disabled{% endif %}">
                                <a class="page-link" href="{{ url_for('report', page=page-1, per_page=per_page, search_query=search_query, period=current_period, start_date=start_date, end_date=end_date) }}" aria-label="Previous">
                                    <span aria-hidden="true">&laquo;</span>
                                </a>
                            </li>
                            {% for p in range(1, total_pages + 1) %}
                            <li class="page-item {% if p == page %}active{% endif %}">
                                <a class="page-link" href="{{ url_for('report', page=p, per_page=per_page, search_query=search_query, period=current_period, start_date=start_date, end_date=end_date) }}">{{ p }}</a>
                            </li>
                            {% endfor %}
                            <li class="page-item {% if page == total_pages %}disabled{% endif %}">
                                <a class="page-link" href="{{ url_for('report', page=page+1, per_page=per_page, search_query=search_query, period=current_period, start_date=start_date, end_date=end_date) }}" aria-label="Next">
                                    <span aria-hidden="true">&raquo;</span>
                                </a>
                            </li>
                        </ul>
                    </nav>
                </div>
                {% elif not report.transactions and not report.total_income and not report.total_expense %}
                <div class="card shadow-sm mb-4">
                    <div class="card-body text-center">
                        <p class="lead">No transactions found for this period.</p>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>

</div>

<!-- New Hidden div for structured PDF content -->
<div id="structured-pdf-content" style="display: none; position: absolute; left: -9999px;">
    <div id="pdf-summary-page" style="width: 190mm;">
        <div style="padding: 10mm;">
            <h1 style="text-align: center; margin-bottom: 5mm;">Budget Report</h1>
            <h3 style="text-align: center; margin-bottom: 8mm;">Report for: {{ report.period|capitalize }} ({{ report.start_date }} to {{ report.end_date }})</h3>

            <div style="display: flex; justify-content: space-around; margin-bottom: 10mm;">
                <div style="text-align: center; width: 30%;">
                    <h4 style="margin-bottom: 5px;">Period Income</h4>
                    <p style="color: green; font-size: 1.2em; font-weight: bold;">$<span id="pdf-period-income"></span></p>
                </div>
                <div style="text-align: center; width: 30%;">
                    <h4 style="margin-bottom: 5px;">Period Expense</h4>
                    <p style="color: red; font-size: 1.2em; font-weight: bold;">$<span id="pdf-period-expense"></span></p>
                </div>
                <div style="text-align: center; width: 30%;">
                    <h4 style="margin-bottom: 5px;">Period Balance</h4>
                    <p style="color: blue; font-size: 1.2em; font-weight: bold;">$<span id="pdf-period-balance"></span></p>
                </div>
            </div>
            <div style="display: flex; justify-content: space-around; margin-bottom: 10mm;">
                <div style="text-align: center; width: 30%;">
                    <h4 style="margin-bottom: 5px;">Goal Savings</h4>
                    <p style="color: purple; font-size: 1.2em; font-weight: bold;">$<span id="pdf-goal-savings"></span></p>
                </div>
                <div style="text-align: center; width: 30%;">
                    <h4 style="margin-bottom: 5px;">General Savings</h4>
                    <p style="color: orange; font-size: 1.2em; font-weight: bold;">$<span id="pdf-general-savings"></span></p>
                </div>
            </div>

            {% if report and report.period == 'monthly' %}
            <div style="margin-top: 10mm; text-align: center; border-top: 1px solid #eee; padding-top: 5mm;">
                <h3 style="margin-bottom: 10mm;">Monthly Budget Goals</h3>
                <p style="margin-bottom: 5px;">Total Budget: <span style="font-weight: bold;">$<span id="pdf-total-budget"></span></span></p>
                <p style="margin-bottom: 5px;">Savings Goal: <span style="font-weight: bold;">$<span id="pdf-savings-goal"></span></span></p>
                <p>Remaining to Spend: <span id="pdf-remaining-spending" style="font-weight: bold;"></span></p>
            </div>
            {% endif %}

            <div id="pdf-pie-chart-placeholder" style="text-align: center; margin-top: 5mm;">
                <!-- Pie chart image will be injected here by JS -->
            </div>
        </div>
    </div>

    <div id="pdf-transactions-page" style="width: 190mm; page-break-before: always;">
        <h2>All Transactions Details</h2>
        <!-- Transactions table will be generated here by jspdf.autoTable -->
    </div>
</div>
{% endblock %}

{% block scripts_extra %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Data for Chart.js
        const expenseCategories = {};
        {% if report and report.transactions %}
            {% for t in report.transactions %}
                {% if t.type == 'expense' %}
                    if (expenseCategories['{{ t.category }}']) {
                        expenseCategories['{{ t.category }}'] += {{ t.amount }};
                    } else {
                        expenseCategories['{{ t.category }}'] = {{ t.amount }};
                    }
                {% endif %}
            {% endfor %}
        {% endif %}

        // Convert to array, sort, and get top 10
        const sortedExpenseCategories = Object.entries(expenseCategories)
            .sort(([, amountA], [, amountB]) => amountB - amountA)
            .slice(0, 10); // Get top 10

        const chartLabels = sortedExpenseCategories.map(([category, amount]) => `${category}: $${amount.toFixed(2)}`);
        const chartData = sortedExpenseCategories.map(([, amount]) => amount);

        const chartColors = [
            '#0d6efd', '#6610f2', '#6f42c1', '#d63384', '#dc3545',
            '#fd7e14', '#ffc107', '#198754', '#20c997', '#0dcaf0',
            '#6c757d', '#adb5bd', '#6f42c1'
        ];

        let expensePieChart; // To hold the chart instance

        function getChartColors() {
            const currentTheme = localStorage.getItem('theme') || 'light';
            return {
                textColor: currentTheme === 'dark' ? '#CCCCCC' : '#333333',
                dataLabelsColor: currentTheme === 'dark' ? '#FFFFFF' : '#FFFFFF'
            };
        }

        function createOrUpdateChart() {
            if (expensePieChart) {
                expensePieChart.destroy(); // Destroy existing chart to redraw
            }

            if (chartLabels.length > 0) {
                const colors = getChartColors();
                const pieCtx = document.getElementById('expensePieChart').getContext('2d');
                expensePieChart = new Chart(pieCtx, {
                    type: 'pie',
                    data: {
                        labels: chartLabels,
                        datasets: [{
                            data: chartData,
                            backgroundColor: chartColors,
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: {
                                    color: colors.textColor
                                }
                            },
                            title: {
                                display: true,
                                text: 'Expense Breakdown by Category',
                                color: colors.textColor
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.raw || 0;
                                        const total = context.chart.getDatasetMeta(0).total;
                                        const percentage = total > 0 ? ((value / total) * 100).toFixed(2) : 0;
                                        return `${label}: $${value.toFixed(2)} (${percentage}%)`;
                                    }
                                }
                            },
                            datalabels: {
                                formatter: (value, ctx) => {
                                    const total = ctx.chart.getDatasetMeta(0).total;
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(2) + '%' : '0%';
                                    return percentage;
                                },
                                color: colors.dataLabelsColor,
                                display: function(context) {
                                    const value = context.dataset.data[context.dataIndex];
                                    const total = context.chart.getDatasetMeta(0).total;
                                    return total > 0 && (value / total) * 100 > 5;
                                }
                            }
                        }
                    },
                    plugins: [ChartDataLabels]
                });
            } else {
                document.getElementById('expensePieChart').style.display = 'none';
                const chartDiv = document.getElementById('expensePieChart').closest('.card-body');
                if (!chartDiv.querySelector('.no-data-message')) { // Avoid adding multiple messages
                    const noDataMessage = document.createElement('p');
                    noDataMessage.className = 'text-center text-muted no-data-message';
                    noDataMessage.textContent = 'No expense data to display for this period.';
                    chartDiv.appendChild(noDataMessage);
                }
            }
        }
        
        // Initial chart creation
        createOrUpdateChart();

        // Listen for theme changes from the theme-toggle button in base.html
        const themeToggle = document.getElementById('theme-toggle');
        if (themeToggle) {
            themeToggle.addEventListener('click', function() {
                // We need to wait a moment for the localStorage to be updated by the other script
                setTimeout(createOrUpdateChart, 100);
            });
        }

        // Export to PDF function
        window.exportReportToPdf = async function() { // Make it global for onclick and async
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            const pdfWidth = doc.internal.pageSize.getWidth();
            const margin = 10;
            const contentWidth = pdfWidth - 2 * margin;

            // --- DATA POPULATION ---
            document.getElementById('pdf-period-income').innerText = ({{ report.total_income | tojson }} !== null ? ({{ report.total_income | tojson }}).toFixed(2) : '0.00');
            document.getElementById('pdf-period-expense').innerText = ({{ displayed_total_expense | tojson }} !== null ? ({{ displayed_total_expense | tojson }}).toFixed(2) : '0.00');
            document.getElementById('pdf-period-balance').innerText = ({{ report.balance | tojson }} !== null ? ({{ report.balance | tojson }}).toFixed(2) : '0.00');
            document.getElementById('pdf-goal-savings').innerText = ({{ report.total_goal_savings | tojson }} !== null ? ({{ report.total_goal_savings | tojson }}).toFixed(2) : '0.00');
            document.getElementById('pdf-general-savings').innerText = ({{ report.total_general_savings | tojson }} !== null ? ({{ report.total_general_savings | tojson }}).toFixed(2) : '0.00');

            {% if report and report.period == 'monthly' %}
            document.getElementById('pdf-total-budget').innerText = ({{ report.total_budget | tojson }}).toFixed(2);
            document.getElementById('pdf-savings-goal').innerText = ({{ report.savings_goal | tojson }}).toFixed(2);
            const remainingSpendingEl = document.getElementById('pdf-remaining-spending');
            const remainingSpending = {{ report.remaining_spending | tojson }};
            remainingSpendingEl.innerText = `$${remainingSpending.toFixed(2)}`;
            remainingSpendingEl.style.color = remainingSpending >= 0 ? 'green' : 'red';
            {% endif %}
            // --- END DATA POPULATION ---

            const structuredPdfContent = document.getElementById('structured-pdf-content');
            const pdfSummaryPage = document.getElementById('pdf-summary-page');
            const mainReportContent = document.getElementById('report-content'); // The visible report content

            // Temporarily hide main report content to prevent rendering issues with hidden divs
            mainReportContent.style.display = 'none';
            structuredPdfContent.style.display = 'block'; // Show the wrapper for rendering

            // 1. Prepare and capture Summary Page (Page 1)
            // Capture pie chart image from its canvas
            const pieChartCanvas = document.getElementById('expensePieChart');
            if (pieChartCanvas) {
                const pieChartImg = pieChartCanvas.toDataURL('image/png');
                const pieChartPlaceholder = document.getElementById('pdf-pie-chart-placeholder');
                if (pieChartPlaceholder) {
                    pieChartPlaceholder.innerHTML = `<img src="${pieChartImg}" style="width: 100mm; height: 100mm;"/>`; // Adjust size for PDF
                }
            }

            // Render summary page
            const summaryCanvas = await html2canvas(pdfSummaryPage, { scale: 2 });
            const summaryImgData = summaryCanvas.toDataURL('image/png');
            const summaryImgProps = doc.getImageProperties(summaryImgData);
            let summaryImgHeight = (summaryImgProps.height * contentWidth) / summaryImgProps.width;
            
            // Add summary page content
            doc.addImage(summaryImgData, 'PNG', margin, margin, contentWidth, summaryImgHeight);

            // 2. Add Transactions Table (Page 2 onwards) using autoTable
            doc.addPage();
            doc.text("All Transactions Details", margin, margin); // Title for transactions page

            const transactionsData = [];
            const transactionsHeaders = [
                ['Date', 'Type', 'Category', 'Item', 'Description', 'Amount']
            ];

            {% for t in report.transactions %}
            transactionsData.push([
                "{{ t.date }}",
                "{{ t.type|capitalize }}",
                "{{ t.category|capitalize }}",
                "{{ t.item }}",
                "{{ t.description }}",
                "$ {{ "%.2f"|format(t.amount) }}"
            ]);
            {% endfor %}

            doc.autoTable({
                startY: margin + 10, // Start below the title
                head: transactionsHeaders,
                body: transactionsData,
                theme: 'striped',
                headStyles: { fillColor: [200, 200, 200], textColor: [0, 0, 0] },
                styles: { fontSize: 8, cellPadding: 2, overflow: 'linebreak' },
                columnStyles: {
                    0: { cellWidth: 20 }, // Date
                    1: { cellWidth: 15 }, // Type
                    2: { cellWidth: 20 }, // Category
                    3: { cellWidth: 30 }, // Item
                    4: { cellWidth: 85 }, // Description
                    5: { cellWidth: 20, halign: 'right' } // Amount
                },
                margin: { top: margin, left: margin, right: margin, bottom: margin },
                didParseCell: function(data) {
                    if (data.column.index === 5 && data.row.section === 'body') { // Amount column
                        const transactionType = data.row.raw[1]; // Get the value of the 'Type' column
                        if (transactionType && transactionType.toLowerCase() === 'expense') {
                            data.cell.styles.textColor = [255, 0, 0]; // Red for expense
                        } else if (transactionType && transactionType.toLowerCase() === 'income') {
                            data.cell.styles.textColor = [0, 128, 0]; // Green for income
                        }
                    }
                }
            });

            // Revert visibility
            structuredPdfContent.style.display = 'none';
            mainReportContent.style.display = 'block';

            doc.save('budget_report_structured.pdf');
        };
    });
</script>
{% endblock %}